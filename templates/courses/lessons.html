{% extends 'base.html' %}
{% block title %} <title>{{ courses.name }} — Lessons</title>{% endblock title %}
{% block hero %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8 mb-4">
      <h3 class="fw-bold">{{ courses.name }} — Lessons</h3>
      <p class="text-muted">{{ courses.bio }}</p>

      <div class="card mb-3">
        <div class="card-body p-3">
          <!-- Main player -->
          <video id="main-player" class="js-player" controls playsinline crossorigin style="width:100%; height:420px; background:#000; object-fit:cover; border-radius:8px;">
            {% comment %} initial source set to first lesson if available {% endcomment %}
            
            {% with first=courses.lessons.all|first %}
              {% if first %}
                <source src="{{ first.video.url }}" type="video/mp4">
              {% endif %}
            {% endwith %}
          </video>
        </div>
      </div>

      <div id="lesson-info" class="mb-4">
        {% with first=courses.lessons.all|first %}
          {% if first %}
            <h5 id="lesson-title">{{ first.name }}</h5>
            <p id="lesson-desc" class="text-muted">{{ first.bio }}</p>
          {% else %}
            <p class="text-muted">No lessons yet.</p>
          {% endif %}
        {% endwith %}
      </div>
    </div>

    <div class="col-lg-4">
      <h6 class="mb-3">All Lessons</h6>
      
      <div class="list-group">
        {% for lesson in courses.lessons.all %}
        <a href="#" class="list-group-item list-group-item-action d-flex gap-3 align-items-center lesson-thumb" data-src="{{ lesson.video.url }}" data-title="{{ lesson.name|escapejs }}" data-desc="{{ lesson.bio|escapejs }}" {% if courses.image %}data-poster="{{ courses.image.url }}"{% endif %}>
          <div style="width:120px; flex:0 0 120px; height:68px; overflow:hidden; border-radius:6px; background:#000; display:flex; align-items:center; justify-content:center;">
            {% if courses.image %}
              <img src="{{ courses.image.url }}" alt="thumb" style="width:100%; height:100%; object-fit:cover;">
            {% else %}
              <img src="https://via.placeholder.com/320x180?text=No+Preview" alt="thumb" style="width:100%; height:100%; object-fit:cover;">
            {% endif %}
            <span class="play-overlay"><i class="bi bi-play-fill"></i></span>
          </div>
          <div>
            <div class="fw-semibold">{{ lesson.name }}</div>
            <small class="text-muted">{{ lesson.bio|truncatechars:80 }}</small>
          </div>
        </a>
        {% empty %}
          <div class="text-muted">No lessons available for this course.</div>
        {% endfor %}
      </div>
    </div>
    <div class="col-12 mt-4">
      <h5 class="mb-3">Comments</h5>
      {% if comments.exists %}
        <div class="list-group">
          {% for c in comments %}
            <div class="list-group-item">
              <div class="d-flex gap-3">
                <div style="flex:0 0 56px;">
                  {% if c.user.image %}
                    <img src="{{ c.user.image.url }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover" />
                  {% else %}
                    <img src="/media/user.png" class="rounded-circle" style="width:48px;height:48px;object-fit:cover" />
                  {% endif %}
                </div>
                <div style="flex:1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <strong>{{ c.user.get_full_name|default:c.user.username }}</strong>
                      <div class="small text-muted">{{ c.texted_at|date:'M d, Y H:i' }}</div>
                    </div>
                  </div>
                  <div class="mt-2">{{ c.comment }}</div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="card p-3 text-muted">No comments yet. Be the first to share your thoughts.</div>
      {% endif %}

      <div class="mt-3">
        <a href="{% url 'write-comment' courses.pk %}" class="btn btn-outline-primary">Write a comment</a>
      </div>
    </div>
  </div>
</div>


<script>
  (function(){
    function findMainPlayer() {
      if (!window.plyrPlayers) return null;
      for (const rec of window.plyrPlayers) {
        if (rec && rec.el && rec.el.id === 'main-player') return rec.player;
      }
      return null;
    }

    function switchVideo(src, poster, title, desc) {
      const player = findMainPlayer();
      if (player) {
        try {
          player.source = {
            type: 'video',
            title: title || '',
            sources: [{ src: src, type: 'video/mp4' }],
            poster: poster || ''
          };
          // Do not autoplay when switching videos; user will press play.
        } catch(e){
          // fallback: change underlying element without autoplay
          const v = document.getElementById('main-player');
          v.pause(); v.src = src; if(poster) v.setAttribute('poster', poster); v.load();
        }
      } else {
        const v = document.getElementById('main-player');
        v.pause(); v.src = src; if(poster) v.setAttribute('poster', poster); v.load();
      }
      // update info
      const titleEl = document.getElementById('lesson-title');
      const descEl = document.getElementById('lesson-desc');
      if (titleEl) titleEl.textContent = title || '';
      if (descEl) descEl.textContent = desc || '';
    }

    document.addEventListener('click', function(e){
      const a = e.target.closest('.lesson-thumb');
      if (!a) return;
      e.preventDefault();
      const src = a.getAttribute('data-src');
      const poster = a.getAttribute('data-poster') || '';
      const title = a.getAttribute('data-title') || '';
      const desc = a.getAttribute('data-desc') || '';
      switchVideo(src, poster, title, desc);
    });
  })();
</script>

{% endblock %}